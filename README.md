# Backend приложения HSE RUN

Этот проект представляет собой backend для приложения HSE RUN, построенный на **FastAPI**. Он включает систему аутентификации, управление командами, функциональность квеста, административную панель и интеграцию с Telegram-ботом.

## Стек технологий

- **Веб-фреймворк**: FastAPI
- **ORM**: SQLAlchemy (асинхронный режим)
- **База данных**: SQLite (легко заменяемая)
- **Система миграций**: Alembic
- **Аутентификация**: Сессии на основе токенов, хранящихся в БД и Cookies.
- **Логирование**: Loguru
- **Telegram Бот**: Aiogram (для определенных взаимодействий)
- **Административная панель**: SQLAdmin
- **Генерация QR**: Segno, Pillow
- **Генерация PDF**: ReportLab
- **Валидация**: Pydantic

## Зависимости проекта

Основные зависимости перечислены в `requirements.txt`. Ключевые пакеты:

- `fastapi[all]`
- `uvicorn`
- `sqlalchemy`
- `alembic`
- `aiosqlite`
- `pydantic`
- `loguru`
- `sqladmin`
- `aiogram`
- `segno`, `Pillow`
- `reportlab`

## Структура проекта

Проект имеет модульную структуру для разделения логики.

```
backend/
├── app/
│   ├── auth/           # Аутентификация, пользователи, команды, роли, QR-коды, программа лояльности
│   ├── cms/            # Интеграция с SQLAdmin (административная панель)
│   ├── dao/            # Data Access Objects (работа с БД)
│   │   ├── database.py # Настройка SQLAlchemy, engine, sessionmaker
│   │   └── base.py     # Базовый класс DAO
│   ├── dependencies/   # FastAPI зависимости (сессии БД, проверка аутентификации)
│   ├── migration/      # Alembic миграции БД
│   ├── quest/          # Логика квеста (блоки, загадки, ответы, подсказки, инсайдеры)
│   ├── static/         # Статические файлы (используются SQLAdmin)
│   ├── tasks/          # Фоновые задачи (например, очистка старых сессий)
│   ├── templates/      # Шаблоны (используются SQLAdmin)
│   ├── utils/          # Общие утилиты
│   ├── config.py       # Конфигурация приложения (из .env)
│   ├── exceptions.py   # Кастомные исключения
│   ├── logger.py       # Настройка Loguru
│   └── main.py         # Точка входа FastAPI, подключение роутеров, middleware
├── data/               # Данные (файл БД SQLite)
├── scripts/            # Скрипты (например, для инициализации данных)
├── tests/              # Тесты
├── .env                # Файл переменных окружения (нужно создать)
├── alembic.ini         # Конфигурация Alembic
├── bot.log             # Логи (может создаваться)
├── README.md           # Этот файл
├── requirements.txt    # Зависимости Python
└── TODO.md             # Список задач
```

### Описание модулей

*   **app/auth**: Управление пользователями, регистрация, вход/выход, сессии, команды (создание, вступление, удаление), роли, генерация и верификация QR-кодов для различных целей, программа лояльности.
*   **app/quest**: Логика игрового квеста. Включает модели и эндпоинты для блоков квеста, загадок, проверки ответов, получения подсказок, отслеживания прогресса команд, логику для "инсайдеров".
*   **app/cms**: Настройка и интеграция административной панели `SQLAdmin`. Позволяет просматривать и редактировать данные напрямую в БД через веб-интерфейс.
*   **app/dao**: Слой доступа к данным. Содержит базовый класс `BaseDAO` и его реализации для каждой модели (`UsersDAO`, `BlocksDAO` и т.д.), инкапсулирующие запросы к БД.
*   **app/dependencies**: Зависимости FastAPI для получения сессии БД (`get_session_with_commit`, `get_session_without_commit`) и проверки аутентификации пользователя (`get_current_user`).
*   **app/tasks**: Фоновые задачи, которые могут выполняться периодически (например, удаление старых сессий). Используется `asyncio`.
*   **app/config.py**: Загрузка и предоставление конфигурационных переменных из файла `.env` с использованием `Pydantic Settings`.
*   **app/main.py**: Инициализация FastAPI приложения, подключение роутеров из модулей (`auth`, `quest`), настройка middleware (например, CORS, обработка ошибок), монтирование статики и запуск `SQLAdmin`.

## Основные API эндпоинты

Документация API генерируется автоматически и доступна по адресу `/docs` (Swagger UI) или `/redoc` (ReDoc) при запущенном приложении.

Ключевые группы эндпоинтов:

### Аутентификация и Пользователи (`/api/auth`)

*   `/registration`: Регистрация нового пользователя (или вход, если пользователь существует).
*   `/login` (может быть частью `/registration`): Вход пользователя.
*   `/logout`: Выход пользователя (удаление сессии).
*   `/me`: Получение информации о текущем аутентифицированном пользователе.
*   `/update_profile`: Обновление профиля пользователя.
*   `/users/{user_id}`: Получение информации о пользователе по ID (доступно администраторам).

### Команды (`/api/auth/command`)

*   `/create`: Создание новой команды.
*   `/join`: Присоединение к команде по токену.
*   `/leave`: Выход из текущей команды.
*   `/delete`: Удаление команды (создателем).
*   `/remove_user`: Удаление пользователя из команды (создателем).

### QR-коды (`/api/auth/qr`)

*   `/`: Генерация QR-кода для текущего пользователя (например, для добавления баллов или других действий).
*   `/verify`: Верификация QR-кода (используется сканирующим устройством/админом).

### Программа лояльности (`/api/auth/program`)

*   `/user/{user_id}`: Получение баллов пользователя.
*   `/add_score`: Добавление баллов пользователю (требует прав).
*   `/qr_add_score`: Добавление баллов по QR-коду.

### Квест (`/api/quest`)

*   `/`: Получение списка всех блоков квеста и текущего состояния команды (очки, монеты).
*   `/{block_id}`: Получение детальной информации о блоке квеста, включая загадки.
*   `/riddles/{riddle_id}/check-answer`: Проверка ответа на загадку.
*   `/riddles/{riddle_id}/hint`: Получение подсказки к загадке (может стоить монет).
*   `/insiders/tasks/status`: (Для инсайдеров) Получение статуса выполнения задач.
*   `/insiders/attendance/mark`: (Для инсайдеров) Отметка о выполнении задания/присутствии.

### Административная панель (`/admin`)

*   Предоставляет веб-интерфейс для управления данными в базе данных (пользователи, команды, блоки квеста и т.д.). Доступ защищен.

## Настройка и Запуск

1.  **Клонируйте репозиторий**:
    ```bash
    git clone <your-repo-url>
    cd backend
    ```

2.  **Создайте и активируйте виртуальное окружение** (рекомендуется):
    ```bash
    python -m venv venv
    source venv/bin/activate  # для Linux/macOS
    # venv\\Scripts\\activate  # для Windows
    ```

3.  **Установите зависимости**:
    ```bash
    pip install -r requirements.txt
    ```

4.  **Создайте файл `.env`** в директории `backend` по образу `.env.example` (если он есть) или со следующими минимальными переменными:
    ```env
    # Секретный ключ для различных операций (например, подписи сессий)
    # Сгенерируйте надежный ключ: openssl rand -hex 32
    SECRET_KEY=ва_секретный_ключ

    # Алгоритм для JWT, если используется (может не использоваться при сессиях в БД)
    # ALGORITHM=HS256

    # URL для подключения к базе данных
    # Для SQLite:
    DATABASE_URL=sqlite+aiosqlite:///./data/db.sqlite3
    # Для PostgreSQL (пример):
    # DATABASE_URL=postgresql+asyncpg://user:password@host:port/database

    # Настройки для Telegram бота (если используются)
    BOT_TOKEN=ваш_токен_бота
    ADMIN_TELEGRAM_ID=ваш_telegram_id_администратора

    # Другие настройки по необходимости (см. app/config.py)
    SESSION_EXPIRE_SECONDS=86400 # Время жизни сессии в секундах (например, 1 день)
    ```
    **Важно**: Убедитесь, что директория `data/` существует, если используете SQLite.

5.  **Примените миграции базы данных**:
    ```bash
    alembic upgrade head
    ```
    Это создаст таблицы в базе данных согласно моделям SQLAlchemy.

6.  **Запустите приложение**:
    ```bash
    uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
    ```
    *   `--reload`: Автоматический перезапуск при изменении кода (для разработки).
    *   `--host 0.0.0.0`: Сделать приложение доступным в локальной сети.
    *   `--port 8000`: Порт, на котором будет запущено приложение.

7.  **Доступ к приложению**:
    *   API будет доступно по адресу `http://localhost:8000` (или указанному хосту/порту).
    *   Документация Swagger UI: `http://localhost:8000/docs`.
    *   Документация ReDoc: `http://localhost:8000/redoc`.
    *   Административная панель: `http://localhost:8000/admin`.

## Миграции базы данных (Alembic)

*   **Создание новой миграции** (после изменения моделей в `app/*/models.py`):
    ```bash
    alembic revision --autogenerate -m "Краткое описание изменений"
    ```
*   **Применение миграций**:
    ```bash
    alembic upgrade head
    ```
*   **Откат последней миграции**:
    ```bash
    alembic downgrade -1
    ```

## Логирование

Логи записываются с использованием `Loguru`. Настройки находятся в `app/logger.py`. По умолчанию логи выводятся в консоль. Файл `bot.log` также может использоваться для записи логов.