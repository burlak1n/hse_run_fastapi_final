{% macro render_program_statistics_component() %}
<div id="program-statistics-component">
    <div id="program-stats-loading">Загрузка статистики...</div>
    <div id="program-stats-content" style="display: none;">
        <!-- График распределения пользователей по баллам -->
        <div class="chart-container">
            <canvas id="programScoreDistributionChart"></canvas>
        </div>
    </div>
</div>

<style>
    .chart-container {
        width: 100%;
        height: 300px;
        margin-top: 20px;
    }
</style>
{% endmacro %}

{% macro program_statistics_scripts() %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Получение данных о пользователях программы
    async function fetchProgramStatistics() {
        try {
            const response = await fetch('/admin/program/stats');
            if (!response.ok) {
                throw new Error('Ошибка при получении данных');
            }
            const data = await response.json();
            if (!data.ok) {
                throw new Error(data.message || 'Ошибка получения данных');
            }
            return data.data;
        } catch (error) {
            console.error('Ошибка:', error);
            return null;
        }
    }
    
    // Отображение графика распределения пользователей по баллам
    async function renderProgramStatistics() {
        const statsLoading = document.getElementById('program-stats-loading');
        const statsContent = document.getElementById('program-stats-content');
        
        try {
            const stats = await fetchProgramStatistics();
            if (!stats) {
                // Просто скрываем загрузку без показа ошибки
                statsLoading.style.display = 'none';
                return;
            }
            
            // Скрываем загрузку и показываем контент
            statsLoading.style.display = 'none';
            statsContent.style.display = 'block';
            
            // Обновляем элементы статистики на странице
            if (document.getElementById('active-users-count')) {
                document.getElementById('active-users-count').textContent = stats.active_users || '0';
            }
            
            if (document.getElementById('total-visits')) {
                document.getElementById('total-visits').textContent = stats.total_visits || '0';
            }
            
            if (document.getElementById('active-commands')) {
                document.getElementById('active-commands').textContent = stats.active_commands || '0';
            }
            
            if (document.getElementById('last-updated')) {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                document.getElementById('last-updated').textContent = `${hours}:${minutes}`;
            }
            
            // График распределения пользователей по баллам
            if (stats.score_distribution && Object.keys(stats.score_distribution).length > 0) {
                const scoreValues = Object.keys(stats.score_distribution).sort((a, b) => parseFloat(a) - parseFloat(b));
                const userCounts = scoreValues.map(score => stats.score_distribution[score]);
                
                // Форматируем значения баллов для меток
                const formattedLabels = scoreValues.map(score => {
                    // Если число целое, показываем как целое, иначе с одним знаком после запятой
                    const scoreNum = parseFloat(score);
                    return (scoreNum % 1 === 0) ? scoreNum + ' баллов' : scoreNum.toFixed(1) + ' баллов';
                });
                
                const scoreCtx = document.getElementById('programScoreDistributionChart').getContext('2d');
                new Chart(scoreCtx, {
                    type: 'bar',
                    data: {
                        labels: formattedLabels,
                        datasets: [{
                            label: 'Количество пользователей',
                            data: userCounts,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                },
                                title: {
                                    display: true,
                                    text: 'Количество пользователей'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Баллы'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Распределение пользователей по количеству баллов',
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const scoreNum = parseFloat(scoreValues[context[0].dataIndex]);
                                        return (scoreNum % 1 === 0) ? scoreNum + ' баллов' : scoreNum.toFixed(1) + ' баллов';
                                    },
                                    label: function(context) {
                                        return `${context.raw} пользователей`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Ошибка при отображении статистики:', error);
            statsLoading.style.display = 'none';
        }
    }
</script>
{% endmacro %} 