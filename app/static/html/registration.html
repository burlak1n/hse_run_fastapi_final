<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSE RUN</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <a href="/">Назад</a>
    <div class="container">
        <h1>HSE RUN</h1>
        <h2>Регистрация</h2>
        <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="test_burlak1n_bot" data-size="large" data-onauth="onTelegramAuth(user)" data-request-access="write"></script>
        <div id="error-message" class="hidden"></div>
        <div id="loading" class="hidden">Загрузка...</div>
        <script type="text/javascript">
        const API_URL = '/api/auth/telegram';

        function showLoading(show) {
            const loadingElement = document.getElementById('loading');
            if (show) {
                loadingElement.classList.remove('hidden');
            } else {
                loadingElement.classList.add('hidden');
            }
        }

        function onTelegramAuth(user) {
            showLoading(true);
            
            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(user)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.json();
            })
            .then(data => {
                if (data.ok) {
                    // Создаем элемент для отображения данных
                    const resultContainer = document.createElement('div');
                    resultContainer.id = 'result-container';
                    resultContainer.style.marginTop = '20px';
                    resultContainer.style.padding = '15px';
                    resultContainer.style.backgroundColor = '#f5f5f5';
                    resultContainer.style.borderRadius = '5px';
                    
                    // Форматируем данные для отображения
                    resultContainer.innerHTML = `
                        <h3>Данные пользователя:</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <p>Перенаправление на профиль через 5 секунд...</p>
                    `;
                    
                    // Добавляем элемент на страницу
                    document.querySelector('.container').appendChild(resultContainer);
                    
                    // Перенаправляем через 5 секунд
                    setTimeout(() => {
                        window.location.href = '/profile';
                    }, 5000);
                } else {
                    showError('Ошибка авторизации: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                showError('Произошла ошибка при авторизации');
            })
            .finally(() => {
                showLoading(false);
            });
        }

        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }
        </script>
    </div>
    <style>
    .hidden { display: none; }
    #loading { /* стили для индикатора загрузки */ }
    </style>
</body>
</html>