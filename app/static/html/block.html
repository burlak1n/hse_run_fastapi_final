<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->
    <title>Quest Block</title>
</head>
<body>
    <h1>HSE RUN</h1>
    <button class="back-button" onclick="window.history.back()">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="team-stats">
        <span>–°—á—ë—Ç: <span id="team-score">0</span></span>
        <span>–ú–æ–Ω–µ—Ç—ã: <span id="team-coins">0</span></span>
        <button onclick="showQR()" style="margin-left: 20px;">–ú–æ–π QR-–∫–æ–¥</button>
    </div>
    <h1 id="block-title"></h1>
    <div id="content"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è QR-–∫–æ–¥–∞ -->
    <div id="qr-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8);">
        <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; text-align: center;">
            <img id="qr-image" src="" alt="QR Code" style="max-width: 300px;">
            <button onclick="closeQR()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const blockId = window.location.pathname.split('/').pop();
        const title = document.getElementById('block-title');
        const content = document.getElementById('content');

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
        const handleError = (message) => {
            content.textContent = message;
            alert(message);
        };

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
        const getFileType = (filePath) => {
            if (!filePath) return 'unknown';
            
            const extension = filePath.split('.').pop().toLowerCase();
            
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
            const videoExtensions = ['mp4', 'webm', 'ogg', 'mov', 'avi'];
            const audioExtensions = ['mp3', 'wav', 'ogg', 'aac'];
            const documentExtensions = ['pdf', 'doc', 'docx', 'txt', 'rtf'];
            
            if (imageExtensions.includes(extension)) return 'image';
            if (videoExtensions.includes(extension)) return 'video';
            if (audioExtensions.includes(extension)) return 'audio';
            if (documentExtensions.includes(extension)) return 'document';
            
            return 'unknown';
        };

        // –°–æ–∑–¥–∞–Ω–∏–µ HTML –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –µ–≥–æ —Ç–∏–ø–∞
        const createFileHTML = (filePath, maxWidth = '300px', additionalStyle = '') => {
            if (!filePath) return '';
            
            const fileType = getFileType(filePath);
            const fileSrc = `/static/img/${filePath}`;
            const extension = filePath.split('.').pop().toLowerCase();
            let html = '';
            
            // –°–æ–∑–¥–∞–µ–º HTML –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            if (fileType === 'image') {
                html = '<img src="' + fileSrc + '" style="max-width: ' + maxWidth + '; ' + additionalStyle + '">';
            } else if (fileType === 'video') {
                html = '<video controls style="max-width: ' + maxWidth + '; ' + additionalStyle + '">' +
                       '<source src="' + fileSrc + '" type="video/' + extension + '">' +
                       '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.' +
                       '</video>';
            } else if (fileType === 'audio') {
                html = '<audio controls style="max-width: ' + maxWidth + '; width: 100%; ' + additionalStyle + '">' +
                       '<source src="' + fileSrc + '" type="audio/' + extension + '">' +
                       '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.' +
                       '</audio>';
            } else if (fileType === 'document' && extension === 'txt') {
                // –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                const safeId = filePath.replace(/[^a-zA-Z0-9]/g, '-');
                html = '<div class="txt-content" id="txt-' + safeId + '" ' +
                       'style="white-space: pre-wrap; overflow-x: auto; max-height: 300px; overflow-y: auto; text-align: left; font-family: monospace; ' + additionalStyle + '">' +
                       '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ...' +
                       '</div>';
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
                setTimeout(function() {
                    const txtId = 'txt-' + safeId;
                    fetch(fileSrc)
                        .then(response => {
                            if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
                            return response.text();
                        })
                        .then(text => {
                            const contentElement = document.querySelector('#' + txtId);
                            if (contentElement) {
                                contentElement.textContent = text;
                            }
                        })
                        .catch(error => {
                            const contentElement = document.querySelector('#' + txtId);
                            if (contentElement) {
                                contentElement.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
                            }
                        });
                }, 0);
            } else {
                // –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
                html = '<div style="max-width: ' + maxWidth + '; padding: 15px; border: 1px solid #ddd; border-radius: 5px; text-align: center; ' + additionalStyle + '">' +
                       '<a href="' + fileSrc + '" target="_blank" style="text-decoration: none; color: #2196f3;">' +
                       '<div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>' +
                       '<div>–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª: ' + filePath + '</div>' +
                       '</a>' +
                       '</div>';
            }
            
            return html;
        };

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –∑–∞–≥–∞–¥–∫–∏
        const createRiddleHTML = (r, index, isAnswered) => {
            const bgColor = index % 2 === 0 ? '#f0f0f0' : '#e0e0e0';
            const { title: riddleTitle = '–ó–∞–≥–∞–¥–∫–∞', geo_answered, text_answered, image_path_answered, image_path, id, has_insider_attempt, has_hint } = r;
            
            // –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Ä–∞–º–∫–∏ –Ω–∞ –∑–µ–ª—ë–Ω—ã–π, –µ—Å–ª–∏ –±—ã–ª–∞ insider-–ø–æ–ø—ã—Ç–∫–∞
            const insiderStyle = has_insider_attempt ? 'border: 2px solid #4caf50;' : '';
            
            return `
                <div class="riddle" style="background-color: ${bgColor}; padding: 20px; margin: 10px auto; border-radius: 8px; max-width: 600px; text-align: center; ${insiderStyle}">
                    <h3>${riddleTitle}</h3>
                    ${isAnswered ? `
                        ${geo_answered ? `<p>${geo_answered}</p>` : ''}
                        <p>${text_answered || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                        ${image_path_answered ? createFileHTML(image_path_answered) : ''}
                    ` : `
                        ${image_path ? createFileHTML(image_path, '300px', 'display: block; margin: 0 auto 20px;') : ''}
                        <div style="margin-bottom: 20px;">
                            <button 
                                onclick="toggleHint('${id}', '${has_hint ? r.hint : ''}')" 
                                ${has_hint ? 'style="background-color: #4caf50;"' : ''}
                                id="hint-button-${id}"
                            >
                                ${has_hint ? '–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É' : '–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É'}
                            </button>
                        </div>
                        <div id="hint-container-${id}" style="display: none; margin-bottom: 20px;">
                            ${has_hint ? createFileHTML(r.hint, '300px', 'border: 2px dashed #2196f3; padding: 10px;') : ''}
                        </div>
                        <div id="hint-error-${id}" style="display: none; color: red; padding: 10px; border: 1px solid red; border-radius: 4px; margin-bottom: 20px;"></div>
                        <form onsubmit="handleRiddleSubmit(event, this, '${id}')" style="margin-top: 20px;">
                            <input placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç" required style="padding: 8px; margin-right: 10px;">
                            <button type="submit">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                        </form>
                    `}
                    ${has_insider_attempt ? '<div style="color: #4caf50; margin-top: 10px;">–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∏–Ω—Å–∞–π–¥–µ—Ä–æ–º</div>' : ''}
                    ${has_hint && !isAnswered ? '<div style="color: #2196f3; margin-top: 10px;">–ü–æ–¥—Å–∫–∞–∑–∫–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–∞</div>' : ''}
                </div>
            `;
        };

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª–æ–∫–∞
        async function loadBlock() {
            try {
                const [response, { block, team_score, team_coins }] = await Promise.all([
                    fetch(`/api/quest/${blockId}`),
                    fetch(`/api/quest/${blockId}`).then(res => res.ok ? res.json() : Promise.reject('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö'))
                ]);
                
                document.getElementById('team-score').textContent = team_score;
                document.getElementById('team-coins').textContent = team_coins;
                title.textContent = block.title;
                
                content.innerHTML = block.riddles?.length 
                    ? block.riddles.map((r, index) => createRiddleHTML(r, index, r.text_answered || r.image_path_answered || r.geo_answered)).join('')
                    : '–ó–∞–≥–∞–¥–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
            } catch (error) {
                handleError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∞');
            }
        }

        async function handleRiddleSubmit(event, form, riddleId) {
            event.preventDefault();
            const answer = form.querySelector('input').value;
            
            try {
                const response = await fetch(`/api/quest/check-answer/${riddleId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer })
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞');
                
                const { isCorrect, updatedRiddle, team_score, team_coins } = await response.json();
                
                if (isCorrect) {
                    const riddleDiv = form.closest('.riddle');
                    riddleDiv.innerHTML = createRiddleHTML(updatedRiddle, 0, true);
                } else {
                    alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç –∏ –º–æ–Ω–µ—Ç—ã
                document.getElementById('team-score').textContent = team_score;
                document.getElementById('team-coins').textContent = team_coins;
            } catch (error) {
                handleError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—Ç–≤–µ—Ç–∞');
            }
        }

        async function requestHint(riddleId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É? –≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –≤–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç.')) return;
            
            try {
                const response = await fetch(`/api/quest/hint/${riddleId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                    throw new Error(errorData.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏');
                }
                
                const data = await response.json();
                
                if (data.hint) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç –∏ –º–æ–Ω–µ—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã
                    if (data.team_score !== null && data.team_coins !== null) {
                        document.getElementById('team-score').textContent = data.team_score;
                        document.getElementById('team-coins').textContent = data.team_coins;
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –±–ª–æ–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
                    await loadBlock();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –±–ª–æ–∫–∞
                    const hintContainer = document.getElementById(`hint-container-${riddleId}`);
                    if (hintContainer) {
                        hintContainer.style.display = 'block';
                    }
                } else {
                    showHintError(riddleId, '–ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                }
            } catch (error) {
                showHintError(riddleId, error.message);
            }
        }

        function showHintError(riddleId, message) {
            const errorContainer = document.getElementById(`hint-error-${riddleId}`);
            if (errorContainer) {
                errorContainer.textContent = message;
                errorContainer.style.display = 'block';
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    errorContainer.style.display = 'none';
                }, 5000);
            } else {
                alert(message); // Fallback
            }
        }

        async function showQR() {
            try {
                const response = await fetch('/api/auth/qr');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR-–∫–æ–¥–∞');
                
                const blob = await response.blob();
                const objectURL = URL.createObjectURL(blob);
                
                document.getElementById('qr-image').src = objectURL;
                document.getElementById('qr-modal').style.display = 'block';
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ QR-–∫–æ–¥–∞');
            }
        }

        function closeQR() {
            document.getElementById('qr-modal').style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        function toggleHint(riddleId, hintPath) {
            // –ï—Å–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –µ—â–µ –Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –µ–µ
            if (!hintPath) {
                requestHint(riddleId);
                return;
            }
            
            // –ï—Å–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞ —É–∂–µ –∑–∞–ø—Ä–æ—à–µ–Ω–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –µ–µ –≤–∏–¥–∏–º–æ—Å—Ç—å
            const hintContainer = document.getElementById(`hint-container-${riddleId}`);
            if (hintContainer) {
                hintContainer.style.display = hintContainer.style.display === 'none' ? 'block' : 'none';
            }
        }

        loadBlock();
    </script>
</body>
</html>