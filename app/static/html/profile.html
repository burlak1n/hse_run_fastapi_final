<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->
    <title>Профиль</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <h1>HSE RUN</h1>
    <a href="/">Назад</a>
    <div class="container">
        <button id="logout-btn">Выйти</button>
        <div id="admin-panel-btn-container" hidden>
            <a href="/admin" class="button" style="display:inline-block; padding:8px 16px; background-color:#007bff; color:white; text-decoration:none; border-radius:4px; margin-top:10px;">Админ-панель</a>
        </div>
        <h2>Профиль</h2>
        <div id="user-info" hidden>
            <p>ФИО: <span id="full_name"></span></p>
            <div id="qr-code-container" hidden>
                <h3>Ваш QR-код</h3>
                <img id="qr-code-img" alt="QR Code" style="width: 200px; height: 200px;">
                <button id="copy-link-btn" style="display: block; margin-top: 10px; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Скопировать ссылку</button>
            </div>
            <div id="team-info" hidden>
                <h3>Ваша команда</h3>
                <p><span id="team-name-info"></span></p>
                <div id="team-participants"></div>
                <!-- <button id="leave-team-btn">Покинуть команду</button> -->
            </div>
            <div id="create-team" hidden>
                <h3>Создать команду</h3>
                <form id="create-team-form">
                    <input type="text" id="team-name-input" placeholder="Название команды" required>
                    <button type="submit">Создать</button>
                </form>
                <div id="team-error" style="color: red; margin-top: 10px;" hidden></div>
            </div>
        </div>
    </div>
    <script>
        const el = selector => document.querySelector(selector);
        const show = selector => el(selector).hidden = false;
        const hide = selector => el(selector).hidden = true;
        const setText = (selector, text) => el(selector).textContent = text;

        async function fetchUserData() {
            try {
                const [userRes, qrRes] = await Promise.all([
                    fetch('/api/auth/me/'),
                    fetch('/api/auth/qr')
                ]);

                if (!userRes.ok || !qrRes.ok) throw new Error('Ошибка загрузки данных');

                const { full_name, commands, role } = await userRes.json();
                const { qr_image, qr_link } = await qrRes.json();

                setText('#full_name', full_name);
                show('#user-info');

                if (role?.name === 'organizer') {
                    show('#admin-panel-btn-container');
                }

                el('#qr-code-img').src = `data:image/png;base64,${qr_image}`;
                show('#qr-code-container');

                el('#copy-link-btn').onclick = () => handleCopyLink(qr_link);

                if (commands?.length) {
                    const team = commands[0];
                    if (team) {
                        setText('#team-name-info', `${team.name} ${team.participants.length}/6`);
                        el('#team-participants').innerHTML = team.participants
                            .map(p => `<p>${p.role === 'captain' ? 'к ' : ''}${p.full_name}</p>`)
                            .join('');
                        show('#team-info');
                    } else {
                        show('#create-team');
                    }
                } else {
                    show('#create-team');
                }
            } catch {
                window.location.href = '/registration';
            }
        }

        async function handleCopyLink(qr_link) {
            try {
                if (navigator.clipboard?.writeText) {
                    await navigator.clipboard.writeText(qr_link);
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = qr_link;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }

                const copyButton = el('#copy-link-btn');
                copyButton.textContent = 'Скопировано!';
                copyButton.style.backgroundColor = '#4CAF50';
                copyButton.disabled = true;

                setTimeout(() => {
                    copyButton.textContent = 'Скопировать ссылку';
                    copyButton.style.backgroundColor = '#007bff';
                    copyButton.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Ошибка при копировании ссылки:', error);
                alert('Не удалось скопировать ссылку: ' + error.message);
            }
        }

        const handleRequest = async (url, method, body) => {
            const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body });
            if (!res.ok) throw new Error('Ошибка запроса');
            window.location.reload();
        };

        el('#logout-btn').onclick = () => handleRequest('/api/auth/logout', 'POST');

        el('#create-team-form').onsubmit = async e => {
            e.preventDefault();
            try {
                await handleRequest('/api/auth/command/create', 'POST', 
                    JSON.stringify({ name: el('#team-name-input').value }));
            } catch (e) {
                setText('#team-error', e.message);
                show('#team-error');
            }
        };

        fetchUserData();
    </script>
</body>
</html>